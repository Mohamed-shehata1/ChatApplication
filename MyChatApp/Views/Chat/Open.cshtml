@model MyChatApp.Models.Chat

@{
    ViewData["Title"] = Model.Title;
}

<div class="row">
    <div class="col-12 mb-3">
        <div class="card chat-header shadow-sm">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">@Model.Title</h5>
                    <small class="text-muted">@Model.Model</small>
                </div>
                <div>
                    <a class="btn btn-outline-secondary" asp-action="Index">Back to Chats</a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="d-flex shadow-sm" style="background:#fff;">
            <div class="chat-window p-3" style="flex:1;">
                <div id="messages" class="messages">
                    @foreach (var m in Model.Messages.OrderBy(m => m.CreatedAt))
                    {
                        var roleClass = m.Role == "user" ? "user" : "assistant";
                        <div class="message @roleClass">
                            <div class="small text-muted">@m.Role</div>
                            <div>@m.Content</div>
                        </div>
                    }
                </div>
                <div class="p-3 border-top bg-light">
                    <div class="input-group">
                        <textarea id="content" class="form-control" rows="3" placeholder="Type your message..."></textarea>
                        <button id="send" class="btn btn-primary">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
async function sendMessage(){
    var contentEl = document.getElementById('content');
    var content = contentEl.value.trim();
    if(!content) return;
    document.getElementById('send').disabled = true;

    var container = document.getElementById('messages');

    try {
        var resp = await fetch('@Url.Action("SendMessage")', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chatId: @Model.Id, content: content })
        });

        // Try to parse JSON; if parsing fails, fall back to text
        let data = null;
        try {
            data = await resp.json();
        } catch (e) {
            const text = await resp.text();
            data = { error: text };
        }

        // Append user message
        var userDiv = document.createElement('div'); userDiv.className = 'message user'; userDiv.innerHTML = '<div class="small text-muted">user</div><div>' + escapeHtml(content) + '</div>';
        container.appendChild(userDiv);

        // Handle non-OK responses
        if (!resp.ok) {
            var errMsg = data?.error ?? ('HTTP ' + resp.status + ' ' + resp.statusText);
            var assistantErr = document.createElement('div'); assistantErr.className = 'message assistant'; assistantErr.innerHTML = '<div class="small text-muted">assistant</div><div>' + escapeHtml(errMsg) + '</div>';
            container.appendChild(assistantErr);
            container.scrollTop = container.scrollHeight;
            contentEl.value = '';
            document.getElementById('send').disabled = false;
            return;
        }

        // Normal successful reply
        var reply = '';
        if (typeof data === 'string') {
            reply = data;
        } else if (data && typeof data === 'object') {
            reply = data.reply ?? data.error ?? JSON.stringify(data);
        }

        var assistantDiv = document.createElement('div'); assistantDiv.className = 'message assistant'; assistantDiv.innerHTML = '<div class="small text-muted">assistant</div><div>' + escapeHtml(reply) + '</div>';
        container.appendChild(assistantDiv);
        container.scrollTop = container.scrollHeight;
        contentEl.value = '';

    } catch (ex) {
        var container = document.getElementById('messages');
        var errDiv = document.createElement('div'); errDiv.className = 'message assistant'; errDiv.innerHTML = '<div class="small text-muted">assistant</div><div>Network error: ' + escapeHtml(ex.message) + '</div>';
        container.appendChild(errDiv);
    } finally {
        document.getElementById('send').disabled = false;
    }
}

// allow ctrl+enter to send
document.getElementById('send').addEventListener('click', sendMessage);

document.getElementById('content').addEventListener('keydown', function(e){
    if((e.ctrlKey || e.metaKey) && e.key === 'Enter'){
        sendMessage();
    }
});

function escapeHtml(unsafe) {
    return unsafe
         .replace(/&/g, '&amp;')
         .replace(/</g, '&lt;')
         .replace(/>/g, '&gt;')
         .replace(/"/g, '&quot;')
         .replace(/'/g, '&#039;');
}
</script>
}
